FROM debian
FROM python

ARG DATABASE_DIALECT
RUN test -n "$DATABASE_DIALECT"
ENV DATABASE_DIALECT $DATABASE_DIALECT

ARG DATABASE_DRIVER
RUN test -n "$DATABASE_DRIVER"
ENV DATABASE_DRIVER $DATABASE_DRIVER

ARG DATABASE_DATABASE
RUN test -n "$DATABASE_DATABASE"
ENV DATABASE_DATABASE $DATABASE_DATABASE

ARG DATABASE_USERNAME
RUN test -n "$DATABASE_USERNAME"
ENV DATABASE_USERNAME $DATABASE_USERNAME

ARG DATABASE_PASSWORD
RUN test -n "$DATABASE_PASSWORD"
ENV DATABASE_PASSWORD $DATABASE_PASSWORD

ARG DATABASE_HOST
RUN test -n "$DATABASE_HOST"
ENV DATABASE_HOST $DATABASE_HOST

ARG DATABASE_PORT
RUN test -n "$DATABASE_PORT"
ENV DATABASE_PORT $DATABASE_PORT

ARG SERVICE_HOST
RUN test -n "$SERVICE_HOST"
ENV SERVICE_HOST $SERVICE_HOST

ARG SERVICE_PORT
RUN test -n "$SERVICE_PORT"
ENV SERVICE_PORT $SERVICE_PORT

WORKDIR /usr/service

ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1

RUN apt-get update
RUN apt-get install -y openssl

COPY requirements-build.txt requirements.txt
RUN pip install -r requirements.txt

COPY src/ src/
RUN mkdir .security

ENV OPENSSL_PEM .security/signature.pem
ENV OPENSSL_PUB .security/signature.pub

RUN openssl genrsa \
    -out $OPENSSL_PEM 2048

RUN openssl rsa \
    -in $OPENSSL_PEM \
    -outform PEM \
    -pubout \
    -out $OPENSSL_PUB

ENTRYPOINT python -m src.run
